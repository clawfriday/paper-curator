Bootstrap: docker
From: node:20-slim

%labels
    Author Paper Curator Team
    Version 1.0
    Description Frontend container for Paper Curator

%post
    mkdir -p /app/src

%files
    # Copy all frontend files - Singularity copies directory contents
    src/frontend/package.json /app/package.json
    src/frontend/package-lock.json /app/package-lock.json
    src/frontend/next.config.js /app/next.config.js
    src/frontend/tsconfig.json /app/tsconfig.json
    src/frontend/tailwind.config.js /app/tailwind.config.js
    src/frontend/postcss.config.js /app/postcss.config.js
    src/frontend/next-env.d.ts /app/next-env.d.ts
    src/frontend/src /app/src

%post
    cd /app
    npm ci || npm install
    # Set BACKEND_URL for build-time (rewrites use this at build time)
    # For Singularity/HPC, backend runs on localhost:3100
    export BACKEND_URL="http://localhost:3100"
    npm run build
    
    # For standalone output, copy static files to standalone directory
    # This is required for Next.js standalone mode to serve static assets
    cp -r /app/.next/static /app/.next/standalone/.next/static
    # Copy public folder if it exists
    if [ -d /app/public ]; then
        cp -r /app/public /app/.next/standalone/public
    fi

%environment
    export NODE_ENV=production
    export PORT=3000
    export HOSTNAME="0.0.0.0"
    # Runtime BACKEND_URL for API routes
    export BACKEND_URL="http://localhost:3100"

%runscript
    cd /app/.next/standalone
    exec node server.js

%startscript
    cd /app/.next/standalone
    exec node server.js

%help
    Paper Curator Frontend Container
    
    Run with:
        singularity run frontend.sif
    
    Or start as instance:
        singularity instance start frontend.sif frontend
